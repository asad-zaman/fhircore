"use strict";(self.webpackChunkfhircore=self.webpackChunkfhircore||[]).push([[6244],{7465:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var r=t(4848),a=t(8453);const s={},i="Running the Backend",o={id:"engineering/quickstart-guide/server-setup",title:"Running the Backend",description:"This guides you through the process of setting up the backend server infrastructure needed to use the OpenSRP 2 app. We then discuss how to deploy optional extensions for administration, data warehousing, integrations, etc.",source:"@site/docs/engineering/quickstart-guide/server-setup.mdx",sourceDirName:"engineering/quickstart-guide",slug:"/engineering/quickstart-guide/server-setup",permalink:"/engineering/quickstart-guide/server-setup",draft:!1,unlisted:!1,editUrl:"https://github.com/opensrp/fhircore/tree/main/docs/engineering/quickstart-guide/server-setup.mdx",tags:[],version:"current",frontMatter:{},sidebar:"defaultSidebar",previous:{title:"Running the App",permalink:"/engineering/quickstart-guide/running-the-app"},next:{title:"Introduction",permalink:"/engineering/app/"}},d={},l=[{value:"Compatability matrix",id:"compatability-matrix",level:2},{value:"FHIR API and data store",id:"fhir-api-and-data-store",level:2},{value:"HAPI FHIR configuration",id:"hapi-fhir-configuration",level:3},{value:"With an identity and access managment service",id:"with-an-identity-and-access-managment-service",level:4},{value:"With no authentication",id:"with-no-authentication",level:4},{value:"Identity and Access Management (IAM)",id:"identity-and-access-management-iam",level:2},{value:"Recommended extensions",id:"recommended-extensions",level:2},{value:"Monitoring",id:"monitoring",level:3},{value:"Admin dashboard",id:"admin-dashboard",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"running-the-backend",children:"Running the Backend"})}),"\n",(0,r.jsx)(n.p,{children:"This guides you through the process of setting up the backend server infrastructure needed to use the OpenSRP 2 app. We then discuss how to deploy optional extensions for administration, data warehousing, integrations, etc."}),"\n",(0,r.jsx)(n.h2,{id:"compatability-matrix",children:"Compatability matrix"}),"\n",(0,r.jsx)(n.p,{children:"These are the recommend versions for a typical health information system setup that will support the OpenSRP2 mobile app."}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Application"}),(0,r.jsx)(n.th,{children:"Recommended Version"}),(0,r.jsx)(n.th,{children:"Reference Link"}),(0,r.jsx)(n.th,{children:"Notes"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"PostgreSQL"}),(0,r.jsx)(n.td,{children:"\u2265 v14"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"https://hub.docker.com/_/postgres/",children:"Official docker images"})}),(0,r.jsx)(n.td,{})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Keycloak"}),(0,r.jsx)(n.td,{children:"v22.0.5"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"https://quay.io/repository/keycloak/keycloak/manifest/sha256:bfa8852e52c279f0857fe8da239c0ad6bbd2cc07793a28a6770f7e24c1e25444",children:"Docker image"})}),(0,r.jsx)(n.td,{})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"FHIR Gateway"}),(0,r.jsx)(n.td,{children:"v1.0.3"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.a,{href:"https://hub.docker.com/layers/onaio/fhir-gateway-plugin/v1.0.3/images/sha256-bb03a9aa4f501072fd913f5d81c9d66b8a1298b4060da4573baf63656266b8f1?context=explore",children:"Docker image"}),(0,r.jsx)("br",{}),(0,r.jsx)(n.a,{href:"https://github.com/onaio/fhir-gateway-plugin/releases/tag/v1.0.3",children:"Github release"})]}),(0,r.jsx)(n.td,{children:"Includes plugins used by OpenSRP"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"HAPI FHIR"}),(0,r.jsx)(n.td,{children:"v6.1.9"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.a,{href:"https://hub.docker.com/layers/onaio/fhir-gateway-plugin/v1.0.3/images/sha256-bb03a9aa4f501072fd913f5d81c9d66b8a1298b4060da4573baf63656266b8f1?context=explore",children:"Docker image"}),(0,r.jsx)("br",{}),(0,r.jsx)(n.a,{href:"https://github.com/onaio/fhir-gateway-plugin/releases/tag/v1.0.3",children:"Github release"})]}),(0,r.jsx)(n.td,{children:"JPA Server Starter"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"FHIR Web"}),(0,r.jsx)(n.td,{children:"v3.1.3"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.a,{href:"https://hub.docker.com/layers/opensrp/web/v3.1.3/images/sha256-48d0ec2aafb0ec2dc7c79dc0f3fbcb55b4802e04c4d836449c8fb46217287afe?context=explore",children:"Docker image"}),(0,r.jsx)("br",{}),(0,r.jsx)(n.a,{href:"https://github.com/onaio/fhir-web/releases/tag/v3.1.3",children:"Github release"})]}),(0,r.jsx)(n.td,{})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Sentry"}),(0,r.jsx)(n.td,{children:"\u2265 v21"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"https://github.com/getsentry/self-hosted/tree/master?tab=readme-ov-file",children:"Documentation"})}),(0,r.jsx)(n.td,{children:"Optional and recommended application monitoring"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"fhir-api-and-data-store",children:"FHIR API and data store"}),"\n",(0,r.jsx)(n.p,{children:"This service is responsible for storing FHIR data and exposing an API that conforms to the FHIR specification. Some options includes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"HAPI FHIR and a PostgreSQL database"}),"\n",(0,r.jsx)(n.li,{children:"Google Cloud Healthcare API"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["See the ",(0,r.jsx)(n.a,{href:"#compatability-matrix",children:"compatability matrix"})," for notes for the versions of HAPI FHIR and PostgreSQL that are know to work with OpenSRP2."]}),"\n",(0,r.jsxs)(n.p,{children:["If you are using Kubernetes, use this ",(0,r.jsx)(n.a,{href:"https://github.com/opensrp/helm-charts/tree/main/charts/hapi-fhir",children:"helm chart"})," to deploy into your cluster."]}),"\n",(0,r.jsx)(n.h3,{id:"hapi-fhir-configuration",children:"HAPI FHIR configuration"}),"\n",(0,r.jsxs)(n.p,{children:["Set the ",(0,r.jsx)(n.code,{children:"Health Probe Endpoint"})," to ",(0,r.jsx)(n.code,{children:"/"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Use the ",(0,r.jsx)(n.code,{children:"JAVA_OPTS"})," environment variable to tune the Java heap size if the application requires more memory."]}),"\n",(0,r.jsx)(n.h4,{id:"with-an-identity-and-access-managment-service",children:"With an identity and access managment service"}),"\n",(0,r.jsxs)(n.p,{children:["If you are using Keycloak as an identity and access management service set the ",(0,r.jsx)(n.code,{children:"SPRING_APPLICATION_JSON"})," environment variables to"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "hapi": {\n    "fhir": {\n      "allow_cascading_deletes": true,\n      "allow_multiple_delete": true,\n      "cors": {\n        "allow_Credentials": true,\n        "allowed_origin": ["*"]\n      },\n      "delete_expunge_enabled": true,\n      "expunge_enabled": true,\n      "fhir_version": "R4",\n      "search-coord-core-pool-size": 20,\n      "search-coord-max-pool-size": 100,\n      "search-coord-queue-capacity": 200,\n      "subscription": {\n        "resthook_enabled": true\n      },\n      "tester": {\n        "global": {\n          "fhir_version": "R4",\n          "name": "Global Tester",\n          "refuse_to_fetch_third_party_urls": false,\n          "server_address": "https://<fhir-domain>/fhir"\n        },\n        "home": {\n          "fhir_version": "R4",\n          "name": "Local Tester",\n          "refuse_to_fetch_third_party_urls": false,\n          "server_address": "https://<fhir-domain>/fhir",\n          "validation": {\n            "requests_enabled": true,\n            "responses_enabled": true\n          }\n        }\n      },\n      "use_apache_address_strategy": true,\n      "use_apache_address_strategy_https": true,\n      "validation": {\n        "requests_enabled": false,\n        "responses_enabled": false\n      }\n    }\n  },\n  "keycloak": {\n    "auth-server-url": "https://<keycloak-domain>/auth/",\n    "credentials": {\n      "secret": "<keycloak-sercret>"\n    },\n    "enabled": true,\n    "realm": "<keycloak-realm>",\n    "resource": "fhir-core-client",\n    "ssl-required": "none"\n  },\n  "sentry": {\n    "enabled": true,\n    "options": {\n      "dsn": "https://<sentry-dns>",\n      "environment": "production",\n      "release": "v6.1.9-SNAPSHOT",\n      "tags": "{\\"release-name\\":\\"fhir-server-auth\\",\\"release-namespace\\":\\"opensrp\\"}"\n    }\n  },\n  "spring": {\n    "batch": {\n      "job": {\n        "enabled": false\n      }\n    },\n    "datasource": {\n      "driverClassName": "org.postgresql.Driver",\n      "max-active": 15,\n      "password": "<password>",\n      "url": "jdbc:postgresql://<postgres-domain>:5432/<postgres-database>",\n      "username": "<postgres-username>"\n    },\n    "flyway": {\n      "baselineOnMigrate": true,\n      "check-location": false,\n      "enabled": false\n    },\n    "jpa": {\n      "properties": {\n        "hibernate.dialect": "org.hibernate.dialect.PostgreSQLDialect",\n        "hibernate.format_sql": false,\n        "hibernate.hbm2ddl.auto": "update",\n        "hibernate.show_sql": false\n      }\n    },\n    "main": {\n      "allow-bean-definition-overriding":true\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h4,{id:"with-no-authentication",children:"With no authentication"}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsx)(n.p,{children:"TO maintain proper privacy and security always use authentication by default. In testing or staging environments where you can guarantee there will be no information on real people it may be acceptible to disable authentication."})}),"\n",(0,r.jsxs)(n.p,{children:["If you are not using authentication set the ",(0,r.jsx)(n.code,{children:"SPRING_APPLICATION_JSON"})," environment variables to:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "hapi": {\n    "fhir": {\n      "allow_cascading_deletes": true,\n      "allow_multiple_delete": true,\n      "cors": {\n        "allow_Credentials": true,\n        "allowed_origin": ["*"]\n      },\n      "delete_expunge_enabled": true,\n      "expunge_enabled": true,\n      "fhir_version": "R4",\n      "search-coord-core-pool-size": 20,\n      "search-coord-max-pool-size": 100,\n      "search-coord-queue-capacity": 200,\n      "server_address":"http://<no-auth-domain or ip>:8080/fhir",\n      "subscription": {\n        "resthook_enabled": true\n      },\n      "tester": {\n        "home": {\n          "fhir_version": "R4",\n          "name": "Local Tester",\n          "refuse_to_fetch_third_party_urls": false,\n          "server_address": "http://localhost:8080/fhir",\n          "validation": {\n            "requests_enabled": true,\n            "responses_enabled": true\n          }\n        }\n      },\n      "use_apache_address_strategy": false,\n      "use_apache_address_strategy_https": false,\n      "validation": {\n        "requests_enabled": false,\n        "responses_enabled": false\n      }\n    }\n  },\n  "keycloak": {\n    "enabled":false\n  },\n  "sentry": {\n    "enabled": true,\n    "options": {\n      "dsn": "https://<sentry-dns>",\n      "environment": "testing",\n      "release": "v6.1.9-SNAPSHOT",\n      "tags": "{\\"release-name\\":\\"fhir-server-auth\\",\\"release-namespace\\":\\"opensrp\\"}"\n    }\n  },\n  "spring": {\n    "batch": {\n      "job": {\n        "enabled": false\n      }\n    },\n    "datasource": {\n      "driverClassName": "org.postgresql.Driver",\n      "max-active": 15,\n      "password": "<password>",\n      "url": "jdbc:postgresql://<postgres-domain>:5432/<postgres-database>",\n      "username": "<postgres-username>"\n    },\n    "flyway": {\n      "baselineOnMigrate": true,\n      "check-location": false,\n      "enabled": false\n    },\n    "jpa": {\n      "properties": {\n        "hibernate.dialect": "org.hibernate.dialect.PostgreSQLDialect",\n        "hibernate.format_sql": false,\n        "hibernate.hbm2ddl.auto": "update",\n        "hibernate.show_sql": false\n      }\n    },\n    "main": {\n      "allow-bean-definition-overriding":true\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"identity-and-access-management-iam",children:"Identity and Access Management (IAM)"}),"\n",(0,r.jsxs)(n.p,{children:["If deploying Keycloak as your IAM service on Kubernetes you can use the following ",(0,r.jsx)(n.code,{children:"values.yml"})," file:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'---\nreplicas: 2\n\nimage:\n  repository: quay.io/keycloak/keycloak\n  tag: "22.0.5"\n  digest: ""\n  pullPolicy: IfNotPresent\n\ningress:\n  enabled: true\n  annotations:\n    ...\n\nserviceMonitor:\n  enabled: true\n\nmetrics:\n  enabled: true\n\nhealth:\n  enabled: true\n\nresources:\n  requests:\n    cpu: "500m"\n    memory: "1024Mi"\n  limits:\n    memory: "2048Mi"\n\ndatabase:\n  vendor: postgres\n  hostname: "<postgres-db-host>"\n  port: 5432\n  database: "<keycloak-db>"\n  username: <username>\n  password: <password>\n\ncommand:\n  - "/opt/keycloak/bin/kc.sh"\n  - "--verbose"\n  - "start"\n  - "--http-enabled=true"\n  - "--http-port=8080"\n  - "--hostname-strict=false"\n  - "--hostname-strict-https=false"\n  - "--spi-events-listener-jboss-logging-success-level=info"\n  - "--spi-events-listener-jboss-logging-error-level=warn"\n\nextraEnv: |\n  - name: KEYCLOAK_ADMIN\n    value: <admin-user>\n  - name: KEYCLOAK_ADMIN_PASSWORD\n    value: <password>\n  - name: JAVA_OPTS_APPEND\n    value: >-\n      -XX:+UseContainerSupport\n      -XX:MaxRAMPercentage=50.0\n      -Djava.awt.headless=true\n      -Djgroups.dns.query={{ include "keycloak.fullname" . }}-headless\n'})}),"\n",(0,r.jsx)(n.h2,{id:"recommended-extensions",children:"Recommended extensions"}),"\n",(0,r.jsx)(n.h3,{id:"monitoring",children:"Monitoring"}),"\n",(0,r.jsx)(n.p,{children:"Once the services have been deployed it will be necessary to monitor the deployed applications. Sentry is integrated into the OpenSRP2 FHIR Android app, FHIR web, and HAPI server to aid in application monitoring and logging."}),"\n",(0,r.jsxs)(n.p,{children:["Apart from application monitoring one has to monitor the server resources and proxy logs. ",(0,r.jsx)(n.a,{href:"https://graylog.org/",children:"Graylog"}),", ",(0,r.jsx)(n.a,{href:"https://fluentbit.io/",children:"fluentbit"}),", and ",(0,r.jsx)(n.a,{href:"https://prometheus.io/",children:"Prometheus"})," are some of the tools that can help with this. It is recommended to configure alerting on these tools to help notify when a threshold is reached and a service is potentially inoperable."]}),"\n",(0,r.jsx)(n.h3,{id:"admin-dashboard",children:"Admin dashboard"}),"\n",(0,r.jsxs)(n.p,{children:["If deploying FHIR web as your admin dashboard on Kubernetes you can use this ",(0,r.jsx)(n.a,{href:"https://github.com/opensrp/helm-charts/tree/main/charts/opensrp-web",children:"helm chart"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>o});var r=t(6540);const a={},s=r.createContext(a);function i(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);